pipeline {
    agent any

    environment {
        SONARQUBE_ENV = 'SQr'                               // Nom du serveur SonarQube dans Jenkins
        DOCKER_IMAGE = 'chaouch2/foyer'                     // Image Docker finale
        SETTINGS_XML_PATH = '/var/lib/jenkins/.m2/settings.xml'
    }

    stages {
        stage('ğŸ“¥ Clone Repository') {
            steps {
                echo 'ğŸ”¹ Cloning the Git repository...'
                sh 'rm -rf devops_projet'
                sh 'git clone https://github.com/chaouch2/devops_projet.git'
            }
        }

        stage('ğŸ§¹ Clean') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ”¹ Cleaning the project...'
                    sh 'mvn clean'
                }
            }
        }

        stage('âš™ï¸ Compile') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ”¹ Compiling the project with Maven...'
                    sh 'mvn compile'
                }
            }
        }

        stage('âœ… Run Unit Tests') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ”¹ Running unit tests...'
                    sh 'mvn test'
                }
            }
        }

        stage('ğŸ§ª Tests dâ€™intÃ©gration') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ”¬ Running integration tests...'
                    sh 'mvn verify -Dskip.unit.tests=true'
                }
            }
        }

        stage('ğŸ“Š VÃ©rification JaCoCo') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ” Checking JaCoCo exec file...'
                    sh 'find . -name "jacoco.exec"'
                }
            }
        }

        stage('ğŸ“„ Rapport HTML JaCoCo') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ“„ GÃ©nÃ©ration du rapport JaCoCo...'
                    sh 'mvn jacoco:report'
                }
            }
        }

        stage('ğŸ“¤ Publication JaCoCo') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸ“¤ Publication du rapport HTML JaCoCo...'
                    publishHTML(target: [
                        reportDir: 'target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'JaCoCo Coverage Report',
                        keepAll: true,
                        alwaysLinkToLastBuild: true,
                        allowMissing: false
                    ])
                }
            }
        }

        stage('ğŸ” Analyse SonarQube') {
            steps {
                dir('devops_projet') {
                    script {
                        withSonarQubeEnv("${SONARQUBE_ENV}") {
                            sh 'mvn sonar:sonar'
                        }
                    }
                }
            }
        }

        stage('ğŸ“¦ DÃ©ploiement Nexus') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸš€ DÃ©ploiement vers Nexus...'
                    sh "mvn deploy -s $SETTINGS_XML_PATH"
                }
            }
        }

stage('Build Docker Image') {
    steps {
        dir('devops_projet') {
            script {
                def status = sh(script: 'docker build -t chaouch2/foyer:latest .', returnStatus: true)
                if (status != 0) {
                    echo "ğŸš¨ Build Ã©chouÃ©, mais on continue quand mÃªme."
                }
            }
        }
    }
}

stage('Push Docker Image') {
    environment {
        DOCKER_IMAGE = 'nouuch/foyer'  // Remplace ici pour ce stage seulement
    }
    steps {
        echo 'ğŸ“¤ Pushing Docker image to DockerHub...'
        withCredentials([usernamePassword(credentialsId: 'docker-credentials-id', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            script {
                try {
                    sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                    sh "docker push ${DOCKER_IMAGE}:latest"
                    sh 'docker logout'
                } catch (err) {
                    echo "âš ï¸ Le push Docker a Ã©chouÃ© mais le pipeline continue : ${err}"
                }
            }
        }
    }
}


        stage('ğŸš€ Run Docker Compose') {
            steps {
                dir('devops_projet') {
                    echo 'ğŸš€ Starting containers with Docker Compose...'
                    sh 'docker compose down || true'
                    sh 'docker compose up -d'
                }
            }
        }
    }
}
stage('ğŸ”’ OWASP Security Scan ğŸ›¡ï¸') {
    steps {
        echo 'ğŸš€ Lancement de l\'analyse de sÃ©curitÃ© OWASP...'
        sh 'mvn org.owasp:dependency-check-maven:check'

        echo 'ğŸ§ VÃ©rification des vulnÃ©rabilitÃ©s critiques (CVSS â‰¥ 7.0)...'
        script {
            def status = sh(script: 'grep -q "CVSS Score: [7-9]" target/dependency-check-report.html', returnStatus: true)
            if (status == 0) {
                echo 'âš ï¸ VulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es !'
                // Tu peux envoyer un mail, Slack, etc.
            } else {
                echo 'âœ… Aucune vulnÃ©rabilitÃ© critique trouvÃ©e.'
            }
        }
    }
}

